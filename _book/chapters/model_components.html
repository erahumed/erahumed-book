<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="The ERAHUMED Decision Support System: Software Manual and Technical Documentation.">

<title>3&nbsp; ERAHUMED model components – ERAHUMED DSS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/erahumed_dss_ui.html" rel="next">
<link href="../chapters/birds_eye_view.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/birds_eye_view.html">Technical description</a></li><li class="breadcrumb-item"><a href="../chapters/model_components.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">ERAHUMED model components</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">ERAHUMED DSS</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Technical description</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/birds_eye_view.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The ERAHUMED model: a bird’s eye view</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/model_components.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">ERAHUMED model components</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">User Manual</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/erahumed_dss_ui.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The ERAHUMED DSS User Interface</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/erahumed_dss_pkg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">The <code>{erahumed}</code> R package</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/input_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Input Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-inp" id="toc-sec-inp" class="nav-link active" data-scroll-target="#sec-inp"><span class="header-section-number">3.1</span> INP: Input Data</a>
  <ul class="collapse">
  <li><a href="#input" id="toc-input" class="nav-link" data-scroll-target="#input"><span class="header-section-number">3.1.1</span> Input</a></li>
  <li><a href="#output" id="toc-output" class="nav-link" data-scroll-target="#output"><span class="header-section-number">3.1.2</span> Output</a></li>
  </ul></li>
  <li><a href="#sec-hba" id="toc-sec-hba" class="nav-link" data-scroll-target="#sec-hba"><span class="header-section-number">3.2</span> HBA: Hydrological Balance of the Albufera lake</a>
  <ul class="collapse">
  <li><a href="#input-1" id="toc-input-1" class="nav-link" data-scroll-target="#input-1"><span class="header-section-number">3.2.1</span> Input</a></li>
  <li><a href="#output-1" id="toc-output-1" class="nav-link" data-scroll-target="#output-1"><span class="header-section-number">3.2.2</span> Output</a></li>
  <li><a href="#details" id="toc-details" class="nav-link" data-scroll-target="#details"><span class="header-section-number">3.2.3</span> Details</a></li>
  </ul></li>
  <li><a href="#sec-hbp" id="toc-sec-hbp" class="nav-link" data-scroll-target="#sec-hbp"><span class="header-section-number">3.3</span> HBP: Hydrological Balance of rice Paddy clusters</a>
  <ul class="collapse">
  <li><a href="#sec-hbp-input" id="toc-sec-hbp-input" class="nav-link" data-scroll-target="#sec-hbp-input"><span class="header-section-number">3.3.1</span> Input</a></li>
  <li><a href="#output-2" id="toc-output-2" class="nav-link" data-scroll-target="#output-2"><span class="header-section-number">3.3.2</span> Output</a></li>
  <li><a href="#sec-hbp-details" id="toc-sec-hbp-details" class="nav-link" data-scroll-target="#sec-hbp-details"><span class="header-section-number">3.3.3</span> Detail</a></li>
  </ul></li>
  <li><a href="#ca-chemical-applications" id="toc-ca-chemical-applications" class="nav-link" data-scroll-target="#ca-chemical-applications"><span class="header-section-number">3.4</span> CA: Chemical Applications</a>
  <ul class="collapse">
  <li><a href="#input-2" id="toc-input-2" class="nav-link" data-scroll-target="#input-2"><span class="header-section-number">3.4.1</span> Input</a></li>
  <li><a href="#output-3" id="toc-output-3" class="nav-link" data-scroll-target="#output-3"><span class="header-section-number">3.4.2</span> Output</a></li>
  <li><a href="#details-1" id="toc-details-1" class="nav-link" data-scroll-target="#details-1"><span class="header-section-number">3.4.3</span> Details</a></li>
  </ul></li>
  <li><a href="#ct-chemical-transport" id="toc-ct-chemical-transport" class="nav-link" data-scroll-target="#ct-chemical-transport"><span class="header-section-number">3.5</span> CT: Chemical Transport</a>
  <ul class="collapse">
  <li><a href="#input-3" id="toc-input-3" class="nav-link" data-scroll-target="#input-3"><span class="header-section-number">3.5.1</span> Input</a></li>
  <li><a href="#output-4" id="toc-output-4" class="nav-link" data-scroll-target="#output-4"><span class="header-section-number">3.5.2</span> Output</a></li>
  <li><a href="#details-2" id="toc-details-2" class="nav-link" data-scroll-target="#details-2"><span class="header-section-number">3.5.3</span> Details</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/birds_eye_view.html">Technical description</a></li><li class="breadcrumb-item"><a href="../chapters/model_components.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">ERAHUMED model components</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">ERAHUMED model components</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This Chapter provides detailed descriptions of the various components of the ERAHUMED model, briefly introduced in <a href="birds_eye_view.html" class="quarto-xref"><span>Chapter 2</span></a>.</p>
<section id="sec-inp" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-inp"><span class="header-section-number">3.1</span> INP: Input Data</h2>
<p>The purpose of this model component is simply to collect the empirical data that provides the observational input to all subsequent modeling layers. This data consists of hydrological and meteorological time series data for the Albufera lake in the desired time frame.</p>
<section id="input" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="input"><span class="header-section-number">3.1.1</span> Input</h3>
<p>The only inputs to this modeling layer are the two aforementioned time-series data-sets.</p>
<p>Hydrological data consists of the direct measurements of the Albufera lake’s daily water levels and outflows. Since the lake has three estuaries (<em>Gola de Pujol</em>, <em>Gola del Perellonet</em> and <em>Gola del Perelló</em>), this data amounts to four daily time series. The actual dataset bundled with the ERAHUMED software was obtained from the public data repository compiled by the <em>Confederación Hidrográfica del Júcar</em> (TODO: Ref.), and is described in more detail in <a href="input_data.html#sec-data-hydro" class="quarto-xref">Appendix&nbsp;<span>A.1</span></a>.</p>
<p>Meteorological data consists of the daily measurements of precipitation and evapotranspiration per unit are, and temperature (average, maximum and minimum). This amounts to five daily the series. The actual data bundled with the ERAHUMED software was obtained (TODO: where), and is described in more detail in <a href="input_data.html#sec-data-meteo" class="quarto-xref">Appendix&nbsp;<span>A.2</span></a>.</p>
<p>The time-series inputs described above are collected in the table below (the common index <span class="math inline">\(t\)</span> refers to the time - <em>i.e.</em> day - of observation).</p>
<div id="tbl-inp-time-series" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-inp-time-series-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.1: Observational input to the ERAHUMED model (INP model component).
</figcaption>
<div aria-describedby="tbl-inp-time-series-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 18%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Input</th>
<th>Units</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(L_t\)</span></td>
<td><span class="math inline">\(\text{m}\)</span></td>
<td>Lake water level</td>
</tr>
<tr class="even">
<td><span class="math inline">\(O_t^{\text{Pujol}}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td><em>Pujol</em> daily outflow</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(O_t^{\text{Perelló}}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td><em>Perelló</em> daily outflow</td>
</tr>
<tr class="even">
<td><span class="math inline">\(O_t^{\text{Perellonet}}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td><em>Perellonet</em> daily outflow</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\text{P}_t\)</span></td>
<td><span class="math inline">\(\text{mm}\)</span></td>
<td>Precipitation (per unit area)</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\text{ETP}_t\)</span></td>
<td><span class="math inline">\(\text{mm}\)</span></td>
<td>Evapotranspiration (per unit area)</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T_t^{\text{max}}\)</span></td>
<td><span class="math inline">\(\text{°C}\)</span></td>
<td>Maximum temperature</td>
</tr>
<tr class="even">
<td><span class="math inline">\(T_t^{\text{min}}\)</span></td>
<td><span class="math inline">\(\text{°C}\)</span></td>
<td>Minimum temperature</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(T_t^{\text{ave}}\)</span></td>
<td><span class="math inline">\(\text{°C}\)</span></td>
<td>Average temperature</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="output" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="output"><span class="header-section-number">3.1.2</span> Output</h3>
<p>This modeling layer does not involve any actual computation, and its output is simply a time-series data-set obtained as the combination of the two input data-sets, <em>i.e.</em> the collection of time series of <a href="#tbl-inp-time-series" class="quarto-xref">Table&nbsp;<span>3.1</span></a>.</p>
</section>
</section>
<section id="sec-hba" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-hba"><span class="header-section-number">3.2</span> HBA: Hydrological Balance of the Albufera lake</h2>
<p>The purpose of this model component is to compute the total daily inflow to the Albufera lake. The relevant equation expressing the hydrological balance is:</p>
<p><span id="eq-hydro-balance-symbolic"><span class="math display">\[
\text{Volume Change} = \text{Inflow} - \text{Outflow} + \text{Precipitation} - \text{Evapotranspiration}
\tag{3.1}\]</span></span></p>
<p>where the unknown is <span class="math inline">\(\text{Inflow}\)</span>, whereas the remaining terms are obtained from observational data, as described in the previous Section (<a href="#sec-inp" class="quarto-xref"><span>Section 3.1</span></a>).</p>
<section id="input-1" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="input-1"><span class="header-section-number">3.2.1</span> Input</h3>
<p>The inputs specific to this layer are two numerical functions converting water heights into the water <em>volumes</em> that appear in <a href="#eq-hydro-balance-symbolic" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>. Specifically:</p>
<ul>
<li>The lake’s <em>storage curve</em> converts the measured lake’s level into a total water volume.</li>
<li>The <em>precipitation-evapotranspiration volume function</em> (or, for the sake of brevity, <em>P-ETP function</em>), that converts precipitation and evapotranspiration values <em>per unit area</em> into an overall water volume difference.</li>
</ul>
<p>Even though the R interface to the ERAHUMED software allows arbitrary definitions, the graphical user interface assumes a linear approximation for both these functions. Therefore, the storage curve is assumed to take the form:</p>
<p><span id="eq-storage-function"><span class="math display">\[
V_t = m \cdot L_t + q,
\tag{3.2}\]</span></span> where <span class="math inline">\(V_t\)</span> is the (daily) water volume of the lake, <span class="math inline">\(L_t\)</span> the corresponding water level (<em>cf.</em> <a href="#tbl-inp-time-series" class="quarto-xref">Table&nbsp;<span>3.1</span></a>), and <span class="math inline">\(m\)</span> and <span class="math inline">\(q\)</span> are numerical coefficients<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Correspondingly, the P-ETP function reads:</p>
<p><span id="eq-petp-function"><span class="math display">\[
\Delta V_t ^{\text{P-ETP}} = \alpha \cdot \text{P}_t - \beta\cdot \text{ETP}_t,
\tag{3.3}\]</span></span> where the left-hand side represents the relevant water volume difference, whereas the <span class="math inline">\(\text{P}\)</span> and <span class="math inline">\(\text{ETP}\)</span> terms in the right-hand side are the measured precipitation and evapotranspiration levels per unit area (<em>cf.</em> <a href="#tbl-inp-time-series" class="quarto-xref">Table&nbsp;<span>3.1</span></a>). The actual default values of <span class="math inline">\(m\)</span>, <span class="math inline">\(q\)</span>, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are documented in <a href="input_data.html#sec-storage-curve" class="quarto-xref">Appendix&nbsp;<span>A.4</span></a>.</p>
</section>
<section id="output-1" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="output-1"><span class="header-section-number">3.2.2</span> Output</h3>
<p>The output of this model consists of the time-series collected in the table below.</p>
<div id="tbl-hba-output" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-hba-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.2: HBA model component outputs
</figcaption>
<div aria-describedby="tbl-hba-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 18%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Units</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(V_t\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Lake water volume</td>
</tr>
<tr class="even">
<td><span class="math inline">\(I_t\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Lake total inflow</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(O_t\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Lake total outflow</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="details" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="details"><span class="header-section-number">3.2.3</span> Details</h3>
<p>Using the notation introduced in the previous Subsections, we can rewrite <a href="#eq-hydro-balance-symbolic" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> as follows:</p>
<p><span id="eq-hydro-balance-explicit"><span class="math display">\[
V_{t+1} - V_t = I_t -O_t +\Delta V^{\text {ETP}}_t,
\tag{3.4}\]</span></span></p>
<p>where <span class="math inline">\(V_t\)</span> and <span class="math inline">\(\Delta V^{\text {ETP}}_t\)</span> are computed through the storage and P-ETP functions, as in Eqs. <a href="#eq-storage-function" class="quarto-xref"><span>3.2</span></a> and <a href="#eq-petp-function" class="quarto-xref"><span>3.3</span></a>. The only terms that requires further clarification in <a href="#eq-hydro-balance-explicit" class="quarto-xref">Equation&nbsp;<span>3.4</span></a> is <span class="math inline">\(O_t\)</span>, the total outflow from the lake.</p>
<p>Strictly speaking, <span class="math inline">\(O_t\)</span> is not merely the sum of <span class="math inline">\(O_t^{\text{Pujol}}\)</span>, <span class="math inline">\(O_t^{\text{Perelló}}\)</span> and <span class="math inline">\(O_t^{\text{Perellonet}}\)</span>, but is rather calculated as follows:</p>
<p><span id="eq-total-outflow"><span class="math display">\[
O_t = \max
\left[
O_t^{\text{Pujol}} + O_t^{\text{Perelló}} + O_t^{\text{Perellonet}},\,
\Delta V^{\text {ETP}}_t+V_t-V_{t+1}
\right].
\tag{3.5}\]</span></span></p>
<p>The rationale is that the simple sum of estuaries outflows omits potentially important contributions from <em>water recirculation</em>, that is to say, water being pumped out from the lake for rice-field irrigation, by the so-called <em>tancats</em>. Such amount of recirculated water is hard to estimate and, in the lack of a better model, we simply assume this to be negligible, <em>except</em> when a positive amount is required by <a href="#eq-hydro-balance-explicit" class="quarto-xref">Equation&nbsp;<span>3.4</span></a> itself, due the physical constraint that <span class="math inline">\(I_t \geq 0\)</span>.</p>
<p>Once <span class="math inline">\(O_t\)</span> is calculated through <a href="#eq-total-outflow" class="quarto-xref">Equation&nbsp;<span>3.5</span></a>, <span class="math inline">\(I_t\)</span> can be immediately obtained from <a href="#eq-hydro-balance-explicit" class="quarto-xref">Equation&nbsp;<span>3.4</span></a>. Notice that whenever the aforementioned compensating outflow term due to water recirculation is included (which happens when the maximum in Eq. <a href="#eq-total-outflow" class="quarto-xref"><span>3.5</span></a> is given by the second term), the total inflow is always estimated to be zero.</p>
</section>
</section>
<section id="sec-hbp" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="sec-hbp"><span class="header-section-number">3.3</span> HBP: Hydrological Balance of rice Paddy clusters</h2>
<p>This modeling layer simulates the local hydrology (<em>i.e.</em> water levels, inflows and outflows) of rice paddy clusters in the Albufera Natural Park. The simulation, that literally involves the generation of a synthetic data-set, is based on:</p>
<ul>
<li>The hydrology of the Albufera lake, which allows to constrain the total outflow of all rice paddies, assumed to be less than or equal to the lake’s total inflow (the main output of the HBA layer, see <a href="#sec-hba" class="quarto-xref"><span>Section 3.2</span></a>).</li>
<li>An estimate of the fraction of the total lake’s inflow that comes from each of the 26 ditches that flow into the Albufera.</li>
<li>A subdivision of the rice fields surface into clusters that are assumed to drain water into a single ditch - meaning that the sum of outflows of clusters from the same group must be less than or equal to the total flow through the corresponding ditch.</li>
<li>An ideal yearly management plan for the irrigation and draining of rice paddies.</li>
</ul>
<section id="sec-hbp-input" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="sec-hbp-input"><span class="header-section-number">3.3.1</span> Input</h3>
<p>As already mentioned, the simulation is based on a spatial clustering, which is described in greater detail in <a href="input_data.html#sec-data-rice-clusters" class="quarto-xref">Appendix&nbsp;<span>A.5</span></a>. In particular each cluster is labeled according to its rice variety, and to its field type (<em>tancat</em> or regular field), which we will indicate in the following through the categorical variables <span class="math inline">\(v = \text{Clearfield, Sendra or Bomba}\)</span> and <span class="math inline">\(\theta =\text{Tancat, Regular}\)</span> respectively.</p>
<p>The yearly management plan for these clusters, is described in <a href="input_data.html#sec-data-albufera-management" class="quarto-xref">Appendix&nbsp;<span>A.3</span></a>, and provides, for each day of the year <span class="math inline">\(d\)</span>, rice variety <span class="math inline">\(v\)</span> and field type <span class="math inline">\(\theta\)</span> the following:</p>
<ul>
<li><span class="math inline">\(\text{Ir}_{d,v,\theta}\)</span>: boolean expressing whether the cluster is supposed to be irrigated (if true) on day of year <span class="math inline">\(d\)</span>.</li>
<li><span class="math inline">\(\text{Dr}_{d,v,\theta}\)</span>: boolean expressing whether the cluster is supposed to be drained (if true) on day of year <span class="math inline">\(d\)</span>.</li>
<li><span class="math inline">\(\mathcal H _{d,v,\theta}\)</span>: ideal water level (in <span class="math inline">\(\text{cm}\)</span>) of the cluster on day of year <span class="math inline">\(d\)</span>.</li>
</ul>
<p>We stress that the values of these yearly series are specific to each rice variety and field type, and the corresponding values for a cluster are obtained by matching with the corresponding cluster’s attributes.</p>
<p>In addition to these rather complex input, the model component requires the following numerical parameters:</p>
<ul>
<li><p><span class="math inline">\(k_\text{flow}\)</span> (<em>Ideal flow rate</em>). Rate at which water flows through rice paddies when these are being simultaneously irrigated and drained, with the overall level being kept constant. Expressed in <span class="math inline">\(\text{cm}\cdot\text{day}^{-1}\)</span>.</p></li>
<li><p><span class="math inline">\(h_{\text{thres}}\)</span> (<em>Height threshold</em>). Maximum allowed water level for a cluster to be considered emptied, used in the calculation of draining/irrigation plan delays. Expressed in <span class="math inline">\(\text{cm}\)</span>.</p></li>
<li><p><span class="math inline">\(\text{seed}\)</span> The seed passed to the random number generator involved in the permutation of clusters described below. Clearly, this parameter is of no physical consequence, its main purpose being to ensure the exact reproducibility of simulations.</p></li>
</ul>
<p>Finally, it should be noted that the simulation involves random sampling (see <a href="#sec-hbp-details" class="quarto-xref">Subsection&nbsp;<span>3.3.3</span></a>), so that the seed of random number generation is an additional pseudo-parameter.</p>
</section>
<section id="output-2" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="output-2"><span class="header-section-number">3.3.2</span> Output</h3>
<p>The output of this layer provides a simulation for the local hydrology of each cluster, summarized by the variables in the table below, in which the indices <span class="math inline">\(c\)</span> and <span class="math inline">\(t\)</span> refer to cluster and time, respectively.</p>
<div id="tbl-hbp-output" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-hbp-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3.3: HBP model component outputs.
</figcaption>
<div aria-describedby="tbl-hbp-output-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 38%">
<col style="width: 18%">
<col style="width: 43%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Units</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(V_{c,t}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Cluster’s water volume</td>
</tr>
<tr class="even">
<td><span class="math inline">\(I_{c,t}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Cluster’s inflow</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(O_{c,t}\)</span></td>
<td><span class="math inline">\(\text{m}^3\)</span></td>
<td>Cluster’s outflow</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="sec-hbp-details" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="sec-hbp-details"><span class="header-section-number">3.3.3</span> Detail</h3>
<p>In the notation introduced above, the purpose of this model layer is to simulate for each cluster <span class="math inline">\(c\)</span> the hydrological time series of <a href="#tbl-hbp-output" class="quarto-xref">Table&nbsp;<span>3.3</span></a>, satisfying the hydrological balance:</p>
<p><span id="eq-hbp-balance"><span class="math display">\[
V_{c,t+1}-V_{c,t} = I_{c,t}-O_{c,t} + (\text{P}_t-\text{ETP}_t)\times A_c
\tag{3.6}\]</span></span></p>
<p>where <span class="math inline">\(\text{P}_t\)</span> and <span class="math inline">\(\text{ETP}_t\)</span> stand for precipitation and evapotranspiration per unit area, as in table <a href="#tbl-inp-time-series" class="quarto-xref">Table&nbsp;<span>3.1</span></a>, whereas <span class="math inline">\(A_c\)</span> denotes the cluster’s area. As mentioned in the introduction to this Section (see <a href="#sec-hbp" class="quarto-xref"><span>3.3</span></a>), this simulation rests on various simplifications, which we detail in what follows.</p>
<p>To begin with, we assume that each cluster only drains water into a single one out of the twenty-six main ditches that cross the Albufera Natural Park. In what follows, we will focus on the set of all clusters connected with a given ditch, and we will enumerate clusters through the index <span class="math inline">\(c = 1,\,2,\,\dots,\,N_C\)</span>. On the other hand, clusters are assumed to be irrigated from the external of the Albufera system, <em>i.e.</em> not through any of the ditches which eventually flow into the lake.</p>
<p>These two assumptions imply that the sum of cluster outflows is constrained by:</p>
<p><span id="eq-sum-outflows-constraint"><span class="math display">\[
\sum _{c = 1} ^ {N_C} O_{c,t} \leq Q_t
\tag{3.7}\]</span></span></p>
<p>where <span class="math inline">\(Q_t\)</span> denotes the daily flow through the ditch. This quantity is, in turn, not measured, and we estimate it through the following simple model:</p>
<p><span id="eq-ditch-inflow"><span class="math display">\[
Q_t = \frac{\text{Area of clusters draining into ditch}}{\text{Area of all clusters}} \times \text{Lake's Inflow}_t
\tag{3.8}\]</span></span></p>
<p>where the lake’s inflow is the one computed by the HBA model component (see <a href="#sec-hba" class="quarto-xref"><span>Section 3.2</span></a>).</p>
<p>Qualitatively speaking, the simulation works by finding daily values of <span class="math inline">\(I_{c,t}\)</span> and <span class="math inline">\(O_{c,t}\)</span> compatible with Eqs. <a href="#eq-hbp-balance" class="quarto-xref"><span>3.6</span></a> and <a href="#eq-sum-outflows-constraint" class="quarto-xref"><span>3.7</span></a>, and such that the resulting hydrology is as close as possible with the “ideal” one prescribed by the specified management plan. This is accomplished in three steps:</p>
<ol type="1">
<li>Computing ideal inflows and outflows, given current water levels and management plans.</li>
<li>Computing actual inflows and outflows, and corresponding actual water level changes.<br>
</li>
<li>Computing required management plan delays, if some clusters were scheduled to be drained, but could not due to insufficient flow through the common ditch (see below for details).</li>
</ol>
<p>These steps are iterated on a daily basis, starting from some initial time (say <span class="math inline">\(t = 0\)</span>) at which all cluster water levels coincide with the ideal ones, and no plan delays are present.</p>
<p>Concerning the last step, a few words may serve to clarify the algorithm described below. The purpose of plan delays is to ensure that during each year’s sowing season, all cluster’s are emptied at some point, as required for ground<br>
applications of chemicals (modeled in subsequent layers of ERAHUMED). This is achieved by delaying by one day the management plan, whenever an emptying condition is not met. When far outside of the sowing window, the delays are reset then to zero, in order to ensure that delays are not carried over indefinitely, which would be quite unrealistic.</p>
<p>In what follows, the conversion between cluster water volumes and depths is provided by <span class="math inline">\(V_{c,t} = A_c \cdot h_{c,t}\)</span>, and we denote by <span class="math inline">\(\delta_{c,t}\)</span> the time-series of plan delays for cluster <span class="math inline">\(c\)</span>, which is initialized by <span class="math inline">\(\delta_{c,0} =0\)</span>.</p>
<section id="step-1-ideal-balance" class="level4" data-number="3.3.3.1">
<h4 data-number="3.3.3.1" class="anchored" data-anchor-id="step-1-ideal-balance"><span class="header-section-number">3.3.3.1</span> Step 1: ideal balance</h4>
<p>Ideal balance quantities for each cluster <span class="math inline">\(c\)</span> are obtained from the management plan data-set, whose relevant row is identified by the cluster’s rice variety <span class="math inline">\(v\)</span> and field type <span class="math inline">\(\theta\)</span>, and the delayed day:</p>
<p><span id="eq-hbp-delayed-day"><span class="math display">\[
d_{c,t+1} = d_{t+1}-\delta_{c,t},
\tag{3.9}\]</span></span></p>
<p>where <span class="math inline">\(d_{t+1}\)</span> denotes the day of year corresponding to time <span class="math inline">\(t+1\)</span>, and <span class="math inline">\(\delta_{c,t}\)</span> the accumulated plan delay.</p>
<p>Let <span class="math inline">\(h _{c,t+1}^{\text{id}}\)</span> denote the ideal depth for cluster <span class="math inline">\(c\)</span> at time <span class="math inline">\(t+1\)</span> retrieved in this way, and <span class="math inline">\(\text{Ir}_{c,t}\)</span>, <span class="math inline">\(\text{Dr}_{c,t}\)</span> the corresponding ideal irrigation and draining plans. Furthermore, denote by <span class="math inline">\(V_{c,t+1}^{\text{id}} = A_c \cdot h_{c,t+1}^{\text{id}}\)</span> the corresponding ideal water volume.</p>
<p>In order to compute ideal inflow and outflow, we require (<em>cf.</em> <a href="#eq-hbp-balance" class="quarto-xref">Equation&nbsp;<span>3.6</span></a>):</p>
<p><span id="eq-hbp-balance-ideal"><span class="math display">\[
V_{c,t+1}^{\text{id}} = \max \lbrace V_{c,t}^{\text{id}}  + (\text{P}_t-\text{ETP}_t)\times A_c,0 \rbrace + I_{c,t}^{\text{id}}-O_{c,t}^{\text{id}}
\tag{3.10}\]</span></span></p>
<p>Clearly, <a href="#eq-hbp-balance-ideal" class="quarto-xref">Equation&nbsp;<span>3.10</span></a> alone does not individually specify <span class="math inline">\(I_{c,t}^{\text{id}}\)</span> and <span class="math inline">\(O_{c,t}^{\text{id}}\)</span>, but only their difference <span class="math inline">\(\Delta _{c,t}^{\text{id}}= I_{c,t}^{\text{id}}-O_{c,t}^{\text{id}}\)</span>. In order to fix both these quantities:</p>
<p><span id="eq-hbp-id-flows-zero"><span class="math display">\[
\begin{split}
(I_{c,t} ^\text{id})^{(0)}&amp;= \begin{cases}
  k_\text{flow}  &amp; \text{if }\text{Ir}_{c,t} = \text{Dr}_{c,t} = 1 \\
  0 &amp; \text{otherwise}
\end{cases},\\
(O_{c,t} ^\text{id})^{(0)}&amp;=(I_{c,t} ^\text{id})^{(0)}-\Delta _{c,t}^{\text{id}}.
\end{split}
\tag{3.11}\]</span></span></p>
<p>and, in order to ensure that flows are positive, we finally set:</p>
<p><span id="eq-hbp-id-flows"><span class="math display">\[
\begin{split}
O_{c,t} ^\text{id} &amp;= \max\lbrace(O_{c,t} ^\text{id})^{(0)},\,0\rbrace\\
I_{c,t} ^\text{id} &amp;= O_{c,t} ^\text{id} + \Delta _{c,t}^{\text{id}},
\end{split}
\tag{3.12}\]</span></span></p>
<p>which satisfy <a href="#eq-hbp-balance-ideal" class="quarto-xref">Equation&nbsp;<span>3.10</span></a> and give rise to positive ^ <span class="math inline">\(O_{c,t}^\text{id}\)</span> and <span class="math inline">\(I_{c,t}^\text{id}\)</span>.</p>
</section>
<section id="step-2-real-balance" class="level4" data-number="3.3.3.2">
<h4 data-number="3.3.3.2" class="anchored" data-anchor-id="step-2-real-balance"><span class="header-section-number">3.3.3.2</span> Step 2: real balance</h4>
<p>At each time-step <span class="math inline">\(t\)</span>, the cluster’s index set is randomly permuted <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, and the real flows are calculated as:</p>
<p><span id="eq-hbp-real-flows"><span class="math display">\[
\begin{split}
O_{c,t} &amp;= \min \lbrace O_{c,t}^\text{id},\,Q_t-\sum_{c'&lt;c}O_{c',t} \rbrace ,\\
I_{c,t} &amp;= \max\lbrace I_{c,t}^\text{id}-O_{c,t}^\text{id} + O_{c,t},\,0 \rbrace
\end{split}
\tag{3.13}\]</span></span></p>
<p>In simple terms, clusters are emptied in a random order within the allowed capacity of the corresponding ditch. Using <a href="#eq-hbp-real-flows" class="quarto-xref">Equation&nbsp;<span>3.13</span></a>, we finally determine the real water level achieved as:</p>
<p><span id="eq-hbp-balance-real"><span class="math display">\[
V_{c,t+1} = \max \lbrace V_{c,t}  + (\text{P}_t-\text{ETP}_t)\times A_c,0 \rbrace + I_{c,t}-O_{c,t}
\tag{3.14}\]</span></span></p>
<p>to be compared with <a href="#eq-hbp-balance-ideal" class="quarto-xref">Equation&nbsp;<span>3.10</span></a>.</p>
</section>
<section id="step-3-updating-the-plan-delay" class="level4" data-number="3.3.3.3">
<h4 data-number="3.3.3.3" class="anchored" data-anchor-id="step-3-updating-the-plan-delay"><span class="header-section-number">3.3.3.3</span> Step 3: updating the plan delay</h4>
<p>The updated value <span class="math inline">\(\delta _{c,t+1}\)</span> is obtained as follows. If <span class="math inline">\(d_{t+1}\)</span> (the <em>actual</em> day of year) is outside of the window <span class="math inline">\(W = [\text{20th of April},\,\text{15th of October}]\)</span>, then <span class="math inline">\(\delta_{c,t+1} = 0\)</span>. Otherwise, if <span class="math inline">\(h_{c,t}^\text{id} &gt; 0\)</span> or <span class="math inline">\(h_{c,t} &lt; h_{\text{thres}}\)</span>, the plan delay is unchanged: <span class="math inline">\(\delta_{c,t+1} = \delta_{c,t}\)</span>. Finally, if <span class="math inline">\(h_{c,t}^\text{id} = 0\)</span> but <span class="math inline">\(h_{c,t} &gt; h_{\text{thres}}\)</span>, we add one day of delay: <span class="math inline">\(\delta_{c,t+1} = \delta_{c,t}+1\)</span>.</p>
</section>
</section>
</section>
<section id="ca-chemical-applications" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="ca-chemical-applications"><span class="header-section-number">3.4</span> CA: Chemical Applications</h2>
<p>This model component describes the application of chemicals to rice fields based on the simulated hydrology computed by the previous layer.</p>
<section id="input-2" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="input-2"><span class="header-section-number">3.4.1</span> Input</h3>
<p>TBD.</p>
</section>
<section id="output-3" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="output-3"><span class="header-section-number">3.4.2</span> Output</h3>
<p>TBD.</p>
</section>
<section id="details-1" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="details-1"><span class="header-section-number">3.4.3</span> Details</h3>
<p>As described above, each application has a scheduled date <span class="math inline">\(D\)</span> and is either of “aerial” or “ground” type. In order to determine the actual application date, we proceed as follows:</p>
<ol type="1">
<li><p>For ground applications, we select only those days in which both <span class="math inline">\(\text{Ir}_{c,t} = \text{Dr}_{c,t} = 0\)</span>, where <span class="math inline">\(\text{Ir}_{c,t}\)</span> and <span class="math inline">\(\text{Dr}_{c,t}\)</span> are the true (in contrast to ideal) irrigation and draining states time-series described after <a href="#eq-hbp-delayed-day" class="quarto-xref">Equation&nbsp;<span>3.9</span></a>. Similarly, for aerial applications, we select days according to <span class="math inline">\(\text{Ir}_{c,t} = \text{Dr}_{c,t} = 1\)</span>.</p></li>
<li><p>For ground applications, out of the days selected in the previous step, we select the subset for which clusters’ simulated water levels satisfy <span class="math inline">\(h_{c,t} &lt; h_{\text{thres}}\)</span>, where <span class="math inline">\(h_{\text{thres}}\)</span> is the same threshold used by the HBP layer (see <a href="#sec-hbp-input" class="quarto-xref"><span>Section 3.3.1</span></a>). For aerial applications, there is no corresponding constraint applied in this step.</p></li>
<li><p>Out of the days selected in the previous step, we select the subset of days that are at least five days away from other applications of the same chemical.</p></li>
<li><p>Finally, from the list of days resulting from all the above steps, we pick the single day for which the <em>delayed day</em> defined by <a href="#eq-hbp-delayed-day" class="quarto-xref">Equation&nbsp;<span>3.9</span></a> is as close as possible to <span class="math inline">\(D\)</span>.</p></li>
</ol>
<p>These steps are meant to be repeated for all subsequent applications of a given chemical in a given cluster. It is worth to notice that the algorithm for simulating clusters’ hydrological balance described in <a href="#sec-hbp" class="quarto-xref"><span>Section 3.3</span></a> guarantees that the list of candidate days for application surviving until the final step above is non-empty.</p>
</section>
</section>
<section id="ct-chemical-transport" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="ct-chemical-transport"><span class="header-section-number">3.5</span> CT: Chemical Transport</h2>
<p>This model component describes the evolution of chemical masses in the three compartments of foliage, water and sediment. This is obtained by solving the system of differential equations that describes the dynamics of chemicals, through a semi-analytic approach with suitable approximations and simplifications.</p>
<section id="input-3" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="input-3"><span class="header-section-number">3.5.1</span> Input</h3>
<p>TBD.</p>
</section>
<section id="output-4" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="output-4"><span class="header-section-number">3.5.2</span> Output</h3>
<p>TBD.</p>
</section>
<section id="details-2" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="details-2"><span class="header-section-number">3.5.3</span> Details</h3>
<p>The evolution of masses in the foliage, water and sediment compartments is described by the following system of differential equations:</p>
<p><span id="eq-ct-ode"><span class="math display">\[
\begin{split}
\dfrac{\text d{m}_f}{\text d t} &amp; = -(k_f+w)m_f+a_f\\
\dfrac{\text d{m}_w}{\text d t} &amp; = -(k_w+d_w+s+\frac{O}{V})m_w+d_sm_s+wm_f+a_w-\sigma(\frac{m_w}{\rho V}) \\
\dfrac{\text d{m}_s}{\text d t} &amp; = (d_w+s)m_w-(k_s+d_s)m_s+a_s+\sigma(\frac{m_w}{\rho V})
\end{split}
\tag{3.15}\]</span></span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(a_{f,w,s}\)</span> are the mass application rates of the chemical in the three compartments,</li>
<li><span class="math inline">\(k_{f,w,s}\)</span> are the degradation rates of the chemical in the three compartments,</li>
<li><span class="math inline">\(d_w\)</span> and <span class="math inline">\(d_s\)</span> are the water-sediment diffusion rates,</li>
<li><span class="math inline">\(s\)</span> is the settling rate,</li>
<li><span class="math inline">\(w\)</span> is the washout rate,</li>
<li><span class="math inline">\(O\)</span> is the outflow rate of the rice field,</li>
<li><span class="math inline">\(V\)</span> is the volume of water in the rice field,</li>
<li><span class="math inline">\(\rho\)</span> is the chemical solubility in water,</li>
<li><span class="math inline">\(\sigma(x)\)</span> is a function (not further specified, see below) that grows quickly for <span class="math inline">\(x &gt; 1\)</span>, and vanishes for <span class="math inline">\(x \leq 1\)</span>. This function accounts for solubility. (TODO: motivate the inclusion of exactly these processes)</li>
</ul>
<p>Strictly speaking, all these terms have instantaneous time dependence<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. Apart from making the <a href="#eq-ct-ode" class="quarto-xref">system&nbsp;<span>3.15</span></a> hard to attack by analytic means, such a dependence is troubling because we don’t have access to the exact time dependence of the majority of these terms (<em>e.g.</em> outflow, volume or chemical applications), our input consisting of simple daily average/cumulative values. On the other hand, if all the terms were constant, and if we could neglect <span class="math inline">\(\sigma\)</span>, the solution of <a href="#eq-ct-ode" class="quarto-xref">Equation&nbsp;<span>3.15</span></a> would be immediate, as the corresponding system becomes a linear ODE with constant coefficients, in addition whose eigenvalues and eigenvectors can be computed explicitly.</p>
<p>What we use in practice is an intermediate semi-analytic approach that allows us to compute daily values of <span class="math inline">\(m_{f,w,s}\)</span>, which we can briefly summarize as follows. The time evolution of <span class="math inline">\(m_{f,w,s}\)</span> in a daily time-step (from <span class="math inline">\(t\)</span> to <span class="math inline">\(t+1\)</span>, say, assuming <span class="math inline">\(t\)</span> is measured in days) is obtained through the following four consecutive stages:</p>
<ol type="1">
<li>We compute the exact evolution of <span class="math inline">\(m_{f,w,s}\)</span> according to the linear ODE obtained by disregarding the processes of outflow, chemical application and solubility, and using daily constant values for all the remaining constants involved (described in more detail below).</li>
<li>We compute the <span class="math inline">\(m_w\)</span> losses due to outflow as if they happened instantaneously after the processes computed in the previous step took place, with the water volume of the rice paddy varying from <span class="math inline">\(V(t)+O(t)\)</span> to <span class="math inline">\(V(t)\)</span><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a><br>
</li>
<li>We compute the mass applications again as instantaneous, after the losses in the water compartment due to outflows took place.</li>
<li>We compare the resulting <span class="math inline">\(m_w\)</span> with the maximum amount allowed by the solubility in water, that is <span class="math inline">\(m_w ^{\text{max}}(t) = \rho V(t)\)</span> and transfer any excess to the sediment compartment (<span class="math inline">\(m_s\)</span>).</li>
</ol>
<p>In the following, we describe in full detail the computations involved in these four steps.</p>
<section id="step-1-linear-ode-evolution-physico-chemical-processes" class="level4" data-number="3.5.3.1">
<h4 data-number="3.5.3.1" class="anchored" data-anchor-id="step-1-linear-ode-evolution-physico-chemical-processes"><span class="header-section-number">3.5.3.1</span> Step 1: linear ODE evolution (physico-chemical processes)</h4>
<p>Disregarding outflow, mass application and solubility, we get a linear ODE of the form:</p>
<p><span id="eq-ct-ode-linear"><span class="math display">\[
\begin{split}
\dfrac{\text d{m}_f}{\text d t} &amp; = \gamma m_f,\\
\dfrac{\text d{m}_w}{\text d t} &amp; = a_{ww} m_w+a_{ws}m_s + w m_f, \\
\dfrac{\text d{m}_s}{\text d t} &amp; = a_{sw}m_w+a_{ss}m_s,
\end{split}
\tag{3.16}\]</span></span></p>
<p>with:</p>
<p><span id="eq-ct-ode-linear-coeffs"><span class="math display">\[
\begin{split}
\gamma                  &amp;= -(k_f + w),\\
a_{ww}                  &amp;= - (k_w + d_ w +s)\\
a_{ws}                  &amp;= d_s\\
a_{sw}                  &amp;= d_w+s\\
a_{ss}                  &amp;= -(k_s+d_s)
\end{split}
\tag{3.17}\]</span></span></p>
<p>where the various physico-chemical parameters are assumed to be constant during a daily time-step (see Sec. TODO for the actual numerical values).</p>
<p>The evolution of <span class="math inline">\(m_f\)</span> is easily obtained:</p>
<p><span id="eq-mf-evolution"><span class="math display">\[
m_f(t) = e^{\gamma t}m_f(0).
\tag{3.18}\]</span></span></p>
<p>Plugging this into the three-dimensional system <a href="#eq-ct-ode-linear" class="quarto-xref"><span>3.16</span></a> we obtain a reduced two-dimensional system for the water-sediment compartments:</p>
<p><span id="eq-ct-ode-linear-reduced"><span class="math display">\[
\begin{split}
\dfrac{\text d{m}_w}{\text d t} &amp; = a_{ww} m_w+a_{ws}m_s + w e ^{\gamma t}m_f(0), \\
\dfrac{\text d{m}_s}{\text d t} &amp; = a_{sw}m_w+a_{ss}m_s,
\end{split}
\tag{3.19}\]</span></span></p>
<p>which is solved explicitly with standard methods<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
</section>
<section id="step-2-mass-losses-due-to-outflow" class="level4" data-number="3.5.3.2">
<h4 data-number="3.5.3.2" class="anchored" data-anchor-id="step-2-mass-losses-due-to-outflow"><span class="header-section-number">3.5.3.2</span> Step 2: mass losses due to outflow</h4>
<p>Mass losses due to outflow are computed as if the outflow process happened instantaneously after the processes discussed in the previous step took place. The amount of mass in the water compartment is affected as follows:</p>
<p><span id="eq-mw-outflow"><span class="math display">\[
m_w \to \frac{V_f}{V_i} m_w,
\tag{3.20}\]</span></span></p>
<p>where <span class="math inline">\(V_i\)</span> and <span class="math inline">\(V_f\)</span> denote the initial and final volume for the outflow process. We assume that <span class="math inline">\(V_f\)</span> coincides with the value <span class="math inline">\(V(t)\)</span> simulated by the HBP model component (<em>cf.</em> Sec TODO), so that <span class="math inline">\(V_i = V(t) + O(t)\)</span>, where <span class="math inline">\(O(t)\)</span> denotes the total simulated outflow for day <span class="math inline">\(t\)</span>.</p>
</section>
<section id="step-3-chemical-applications" class="level4" data-number="3.5.3.3">
<h4 data-number="3.5.3.3" class="anchored" data-anchor-id="step-3-chemical-applications"><span class="header-section-number">3.5.3.3</span> Step 3: chemical applications</h4>
<p>Applications are computed as instantaneous and subsequent to outflow. Masses in the various compartments (<span class="math inline">\(i = f,\,w,\,s\)</span>) are modified as follows:</p>
<p><span id="eq-mi-application"><span class="math display">\[
m_i \to m_i + a_i
\tag{3.21}\]</span></span></p>
</section>
<section id="step-4-solubility" class="level4" data-number="3.5.3.4">
<h4 data-number="3.5.3.4" class="anchored" data-anchor-id="step-4-solubility"><span class="header-section-number">3.5.3.4</span> Step 4: solubility</h4>
<p>The chemical density in the water compartment after Steps 1, 2, and 3 is eventually compared with the chemical’s solubility <span class="math inline">\(\rho\)</span>, and any mass excess is instantaneously transferred to the sediment compartment. This implies the following modifications:</p>
<p><span id="eq-m-solubility"><span class="math display">\[
m_s \to m_s + \max(0, \,m_w - \rho V),\quad m_w\to\max(m_w,\,\rho V),
\tag{3.22}\]</span></span></p>
<p>where, for the volume <span class="math inline">\(V\)</span> we again use the value <span class="math inline">\(V(t)\)</span> simulated by the HBP model component.</p>


</section>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>In fact, for the purpose of computing volume <em>changes</em> entering the hydrological balance <a href="#eq-hydro-balance-symbolic" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>, only the slope <span class="math inline">\(m\)</span> is required.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>With some abuse of notation, we assume the indexes <span class="math inline">\(c\)</span> and <span class="math inline">\(c'\)</span> in <a href="#eq-hbp-real-flows" class="quarto-xref">Equation&nbsp;<span>3.13</span></a> to be sorted according to this random permutation.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p> This observation also includes pure physico-chemical “constants” such as degradation rates, where the time dependence would stem from <em>temperature</em> dependence.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p> Recall that, in the notation of TODO, <span class="math inline">\(V(t)\)</span> denotes the final volume on day <span class="math inline">\(t\)</span>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Letting <span class="math inline">\(x = (m_w,\,m_s)^T\)</span> and <span class="math inline">\(b = w(m_f(0),0)^T\)</span>, the system can be rewritten in the form: <span class="math display">\[ \dot x = Ax + e^{\gamma t }b \]</span> where <span class="math display">\[ A = \begin{pmatrix} a_{ww} &amp; a_{ws} \\ a_{sw} &amp; a_{ss} \end{pmatrix} \]</span> The general solution reads: <span class="math display">\[
  x(t) = e^{At}x(0)+(e^{At}-e^{\gamma t}I)(A-\gamma I)^{-1}b
  \]</span> where <span class="math inline">\(I\)</span> is the identity matrix. Notice that the exponential can be computed explicitly from the eigenvalues of <span class="math inline">\(A\)</span>: <span class="math display">\[
  e^{At} = e^{\lambda _+ t} P_+ + e^{\lambda _- t} P_-,
  \]</span> with: <span class="math display">\[
  \lambda _{\pm} = \frac{\text{Tr}A}{2} \sqrt{\left(\frac{\text{Tr}A}{2}\right)^2 - \det A}
  \]</span> and <span class="math display">\[
  P_{\pm} = \pm \frac{1}{\lambda _+ - \lambda _-}(A-\lambda _{\mp})
  \]</span><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/birds_eye_view.html" class="pagination-link" aria-label="The ERAHUMED model: a bird's eye view">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The ERAHUMED model: a bird’s eye view</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/erahumed_dss_ui.html" class="pagination-link" aria-label="The ERAHUMED DSS User Interface">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The ERAHUMED DSS User Interface</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>